{"version":3,"sources":["../../../src/core/DndProvider.tsx"],"sourcesContent":["import { FC, useEffect, memo, ReactNode } from 'react'\nimport {\n\tBackendFactory,\n\tDragDropManager,\n\tcreateDragDropManager,\n} from 'dnd-core'\nimport { DndContext } from './DndContext.js'\n\nexport type DndProviderProps<BackendContext, BackendOptions> =\n\t| {\n\t\t\tchildren?: ReactNode\n\t\t\tmanager: DragDropManager\n\t  }\n\t| {\n\t\t\tbackend: BackendFactory\n\t\t\tchildren?: ReactNode\n\t\t\tcontext?: BackendContext\n\t\t\toptions?: BackendOptions\n\t\t\tdebugMode?: boolean\n\t  }\n\nlet refCount = 0\nconst INSTANCE_SYM = Symbol.for('__REACT_DND_CONTEXT_INSTANCE__')\n\n/**\n * A React component that provides the React-DnD context\n */\nexport const DndProvider: FC<DndProviderProps<unknown, unknown>> = memo(\n\tfunction DndProvider({ children, ...props }) {\n\t\tconst [manager, isGlobalInstance] = getDndContextValue(props) // memoized from props\n\t\t/**\n\t\t * If the global context was used to store the DND context\n\t\t * then where theres no more references to it we should\n\t\t * clean it up to avoid memory leaks\n\t\t */\n\t\tuseEffect(() => {\n\t\t\tif (isGlobalInstance) {\n\t\t\t\tconst context = getGlobalContext()\n\t\t\t\t++refCount\n\n\t\t\t\treturn () => {\n\t\t\t\t\tif (--refCount === 0) {\n\t\t\t\t\t\tcontext[INSTANCE_SYM] = null\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn\n\t\t}, [])\n\n\t\treturn <DndContext.Provider value={manager}>{children}</DndContext.Provider>\n\t},\n)\n\nfunction getDndContextValue(props: DndProviderProps<unknown, unknown>) {\n\tif ('manager' in props) {\n\t\tconst manager = { dragDropManager: props.manager }\n\t\treturn [manager, false]\n\t}\n\n\tconst manager = createSingletonDndContext(\n\t\tprops.backend,\n\t\tprops.context,\n\t\tprops.options,\n\t\tprops.debugMode,\n\t)\n\tconst isGlobalInstance = !props.context\n\n\treturn [manager, isGlobalInstance]\n}\n\nfunction createSingletonDndContext<BackendContext, BackendOptions>(\n\tbackend: BackendFactory,\n\tcontext: BackendContext = getGlobalContext(),\n\toptions: BackendOptions,\n\tdebugMode?: boolean,\n) {\n\tconst ctx = context as any\n\tif (!ctx[INSTANCE_SYM]) {\n\t\tctx[INSTANCE_SYM] = {\n\t\t\tdragDropManager: createDragDropManager(\n\t\t\t\tbackend,\n\t\t\t\tcontext,\n\t\t\t\toptions,\n\t\t\t\tdebugMode,\n\t\t\t),\n\t\t}\n\t}\n\treturn ctx[INSTANCE_SYM]\n}\n\ndeclare const global: any\nfunction getGlobalContext() {\n\treturn typeof global !== 'undefined' ? global : (window as any)\n}\n"],"names":["useEffect","memo","createDragDropManager","DndContext","refCount","INSTANCE_SYM","Symbol","for","DndProvider","children","props","manager","isGlobalInstance","getDndContextValue","context","getGlobalContext","Provider","value","dragDropManager","createSingletonDndContext","backend","options","debugMode","ctx","global","window"],"mappings":";AAAA,MAAM,GAAOA,SAAS,EAAEC,IAAI,QAAmB,CAAO;AACtD,MAAM,GAGLC,qBAAqB,QACf,CAAU;AACjB,MAAM,GAAGC,UAAU,QAAQ,CAAiB;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAe5C,GAAG,CAACC,QAAQ,GAAG,CAAC;AAChB,KAAK,CAACC,YAAY,GAAGC,MAAM,CAACC,GAAG,CAAC,CAAgC;IAKnDC,WAAW,iBAA2CP,IAAI,CACtE,QAAQ,CAACO,WAAW,CAAC,MAAsB,EAAE,CAAC;QAAzB,CAAC,CAACC,QAAQ,EAAW,CAAC,GAAtB,MAAsB,EAAPC,KAAK,4BAApB,MAAsB;QAApBD,CAAQ;;IAC9B,KAAK,EAAEE,OAAO,EAAEC,gBAAgB,IAAIC,kBAAkB,CAACH,KAAK,CAAE,CAAsB,AAAtB,EAAsB,AAAtB,oBAAsB;;IACpF,EAIG,AAJH;;;;GAIG,AAJH,EAIG,CACHV,SAAS,KAAO,CAAC;QAChB,EAAE,EAAEY,gBAAgB,EAAE,CAAC;YACtB,KAAK,CAACE,OAAO,GAAGC,gBAAgB;cAC9BX,QAAQ;YAEV,MAAM,KAAO,CAAC;gBACb,EAAE,IAAIA,QAAQ,KAAK,CAAC,EAAE,CAAC;oBACtBU,OAAO,CAACT,YAAY,IAAI,IAAI;gBAC7B,CAAC;YACF,CAAC;QACF,CAAC;QACD,MAAM;IACP,CAAC,EAAE,CAAC,CAAC;IAEL,MAAM,oBAAEF,UAAU,CAACa,QAAQ;QAACC,KAAK,EAAEN,OAAO;kBAAGF,QAAQ;;AACtD,CAAC;AA1BF,EAEG,AAFH;;CAEG,AAFH,EAEG,CACH,MAAM;SA0BGI,kBAAkB,CAACH,KAAyC,EAAE,CAAC;IACvE,EAAE,EAAE,CAAS,YAAIA,KAAK,EAAE,CAAC;QACxB,KAAK,CAACC,OAAO,GAAG,CAAC;YAACO,eAAe,EAAER,KAAK,CAACC,OAAO;QAAC,CAAC;QAClD,MAAM,CAAC,CAACA;YAAAA,OAAO;YAAE,KAAK;QAAA,CAAC;IACxB,CAAC;IAED,KAAK,CAACA,OAAO,GAAGQ,yBAAyB,CACxCT,KAAK,CAACU,OAAO,EACbV,KAAK,CAACI,OAAO,EACbJ,KAAK,CAACW,OAAO,EACbX,KAAK,CAACY,SAAS;IAEhB,KAAK,CAACV,gBAAgB,IAAIF,KAAK,CAACI,OAAO;IAEvC,MAAM,CAAC,CAACH;QAAAA,OAAO;QAAEC,gBAAgB;IAAA,CAAC;AACnC,CAAC;SAEQO,yBAAyB,CACjCC,OAAuB,EACvBN,OAAuB,GAAGC,gBAAgB,IAC1CM,OAAuB,EACvBC,SAAmB,EAClB,CAAC;IACF,KAAK,CAACC,GAAG,GAAGT,OAAO;IACnB,EAAE,GAAGS,GAAG,CAAClB,YAAY,GAAG,CAAC;QACxBkB,GAAG,CAAClB,YAAY,IAAI,CAAC;YACpBa,eAAe,EAAEhB,qBAAqB,CACrCkB,OAAO,EACPN,OAAO,EACPO,OAAO,EACPC,SAAS;QAEX,CAAC;IACF,CAAC;IACD,MAAM,CAACC,GAAG,CAAClB,YAAY;AACxB,CAAC;SAGQU,gBAAgB,GAAG,CAAC;IAC5B,MAAM,CAAC,MAAM,CAACS,MAAM,KAAK,CAAW,aAAGA,MAAM,GAAIC,MAAM;AACxD,CAAC"}