{"version":3,"sources":["../../src/OffsetUtils.ts"],"sourcesContent":["import { isSafari, isFirefox } from './BrowserDetector.js'\nimport { MonotonicInterpolant } from './MonotonicInterpolant.js'\nimport type { XYCoord } from 'dnd-core'\n\nconst ELEMENT_NODE = 1\n\nexport function getNodeClientOffset(node: Node): XYCoord | null {\n\tconst el = node.nodeType === ELEMENT_NODE ? node : node.parentElement\n\n\tif (!el) {\n\t\treturn null\n\t}\n\n\tconst { top, left } = (el as HTMLElement).getBoundingClientRect()\n\treturn { x: left, y: top }\n}\n\nexport function getEventClientOffset(e: MouseEvent): XYCoord {\n\treturn {\n\t\tx: e.clientX,\n\t\ty: e.clientY,\n\t}\n}\n\nfunction isImageNode(node: any) {\n\treturn (\n\t\tnode.nodeName === 'IMG' &&\n\t\t(isFirefox() || !document.documentElement?.contains(node))\n\t)\n}\n\nfunction getDragPreviewSize(\n\tisImage: boolean,\n\tdragPreview: any,\n\tsourceWidth: number,\n\tsourceHeight: number,\n) {\n\tlet dragPreviewWidth = isImage ? dragPreview.width : sourceWidth\n\tlet dragPreviewHeight = isImage ? dragPreview.height : sourceHeight\n\n\t// Work around @2x coordinate discrepancies in browsers\n\tif (isSafari() && isImage) {\n\t\tdragPreviewHeight /= window.devicePixelRatio\n\t\tdragPreviewWidth /= window.devicePixelRatio\n\t}\n\treturn { dragPreviewWidth, dragPreviewHeight }\n}\n\nexport function getDragPreviewOffset(\n\tsourceNode: HTMLElement,\n\tdragPreview: HTMLElement,\n\tclientOffset: XYCoord,\n\tanchorPoint: { anchorX: number; anchorY: number },\n\toffsetPoint: { offsetX: number; offsetY: number },\n): XYCoord {\n\t// The browsers will use the image intrinsic size under different conditions.\n\t// Firefox only cares if it's an image, but WebKit also wants it to be detached.\n\tconst isImage = isImageNode(dragPreview)\n\tconst dragPreviewNode = isImage ? sourceNode : dragPreview\n\tconst dragPreviewNodeOffsetFromClient = getNodeClientOffset(\n\t\tdragPreviewNode,\n\t) as XYCoord\n\tconst offsetFromDragPreview = {\n\t\tx: clientOffset.x - dragPreviewNodeOffsetFromClient.x,\n\t\ty: clientOffset.y - dragPreviewNodeOffsetFromClient.y,\n\t}\n\tconst { offsetWidth: sourceWidth, offsetHeight: sourceHeight } = sourceNode\n\tconst { anchorX, anchorY } = anchorPoint\n\tconst { dragPreviewWidth, dragPreviewHeight } = getDragPreviewSize(\n\t\tisImage,\n\t\tdragPreview,\n\t\tsourceWidth,\n\t\tsourceHeight,\n\t)\n\n\tconst calculateYOffset = () => {\n\t\tconst interpolantY = new MonotonicInterpolant(\n\t\t\t[0, 0.5, 1],\n\t\t\t[\n\t\t\t\t// Dock to the top\n\t\t\t\toffsetFromDragPreview.y,\n\t\t\t\t// Align at the center\n\t\t\t\t(offsetFromDragPreview.y / sourceHeight) * dragPreviewHeight,\n\t\t\t\t// Dock to the bottom\n\t\t\t\toffsetFromDragPreview.y + dragPreviewHeight - sourceHeight,\n\t\t\t],\n\t\t)\n\t\tlet y = interpolantY.interpolate(anchorY)\n\t\t// Work around Safari 8 positioning bug\n\t\tif (isSafari() && isImage) {\n\t\t\t// We'll have to wait for @3x to see if this is entirely correct\n\t\t\ty += (window.devicePixelRatio - 1) * dragPreviewHeight\n\t\t}\n\t\treturn y\n\t}\n\n\tconst calculateXOffset = () => {\n\t\t// Interpolate coordinates depending on anchor point\n\t\t// If you know a simpler way to do this, let me know\n\t\tconst interpolantX = new MonotonicInterpolant(\n\t\t\t[0, 0.5, 1],\n\t\t\t[\n\t\t\t\t// Dock to the left\n\t\t\t\toffsetFromDragPreview.x,\n\t\t\t\t// Align at the center\n\t\t\t\t(offsetFromDragPreview.x / sourceWidth) * dragPreviewWidth,\n\t\t\t\t// Dock to the right\n\t\t\t\toffsetFromDragPreview.x + dragPreviewWidth - sourceWidth,\n\t\t\t],\n\t\t)\n\t\treturn interpolantX.interpolate(anchorX)\n\t}\n\n\t// Force offsets if specified in the options.\n\tconst { offsetX, offsetY } = offsetPoint\n\tconst isManualOffsetX = offsetX === 0 || offsetX\n\tconst isManualOffsetY = offsetY === 0 || offsetY\n\treturn {\n\t\tx: isManualOffsetX ? offsetX : calculateXOffset(),\n\t\ty: isManualOffsetY ? offsetY : calculateYOffset(),\n\t}\n}\n"],"names":["getNodeClientOffset","getEventClientOffset","getDragPreviewOffset","ELEMENT_NODE","node","el","nodeType","parentElement","top","left","getBoundingClientRect","x","y","e","clientX","clientY","isImageNode","document","nodeName","isFirefox","documentElement","contains","getDragPreviewSize","isImage","dragPreview","sourceWidth","sourceHeight","dragPreviewWidth","width","dragPreviewHeight","height","isSafari","window","devicePixelRatio","sourceNode","clientOffset","anchorPoint","offsetPoint","dragPreviewNode","dragPreviewNodeOffsetFromClient","offsetFromDragPreview","offsetWidth","offsetHeight","anchorX","anchorY","calculateYOffset","interpolantY","MonotonicInterpolant","interpolate","calculateXOffset","interpolantX","offsetX","offsetY","isManualOffsetX","isManualOffsetY"],"mappings":"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"}