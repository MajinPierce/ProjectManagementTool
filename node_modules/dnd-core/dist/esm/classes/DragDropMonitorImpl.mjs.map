{"version":3,"sources":["../../../src/classes/DragDropMonitorImpl.ts"],"sourcesContent":["import type { Store } from 'redux'\nimport { invariant } from '@react-dnd/invariant'\nimport { matchesType } from '../utils/matchesType.js'\nimport {\n\tgetSourceClientOffset,\n\tgetDifferenceFromInitialOffset,\n} from '../utils/coords.js'\nimport { areDirty } from '../utils/dirtiness.js'\nimport type { State } from '../reducers/index.js'\nimport type {\n\tDragDropMonitor,\n\tListener,\n\tUnsubscribe,\n\tXYCoord,\n\tHandlerRegistry,\n\tIdentifier,\n} from '../interfaces.js'\n\nexport class DragDropMonitorImpl implements DragDropMonitor {\n\tprivate store: Store<State>\n\tpublic readonly registry: HandlerRegistry\n\n\tpublic constructor(store: Store<State>, registry: HandlerRegistry) {\n\t\tthis.store = store\n\t\tthis.registry = registry\n\t}\n\n\tpublic subscribeToStateChange(\n\t\tlistener: Listener,\n\t\toptions: { handlerIds?: string[] } = {},\n\t): Unsubscribe {\n\t\tconst { handlerIds } = options\n\t\tinvariant(typeof listener === 'function', 'listener must be a function.')\n\t\tinvariant(\n\t\t\ttypeof handlerIds === 'undefined' || Array.isArray(handlerIds),\n\t\t\t'handlerIds, when specified, must be an array of strings.',\n\t\t)\n\n\t\tlet prevStateId = this.store.getState().stateId\n\t\tconst handleChange = () => {\n\t\t\tconst state = this.store.getState()\n\t\t\tconst currentStateId = state.stateId\n\t\t\ttry {\n\t\t\t\tconst canSkipListener =\n\t\t\t\t\tcurrentStateId === prevStateId ||\n\t\t\t\t\t(currentStateId === prevStateId + 1 &&\n\t\t\t\t\t\t!areDirty(state.dirtyHandlerIds, handlerIds))\n\n\t\t\t\tif (!canSkipListener) {\n\t\t\t\t\tlistener()\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tprevStateId = currentStateId\n\t\t\t}\n\t\t}\n\n\t\treturn this.store.subscribe(handleChange)\n\t}\n\n\tpublic subscribeToOffsetChange(listener: Listener): Unsubscribe {\n\t\tinvariant(typeof listener === 'function', 'listener must be a function.')\n\n\t\tlet previousState = this.store.getState().dragOffset\n\t\tconst handleChange = () => {\n\t\t\tconst nextState = this.store.getState().dragOffset\n\t\t\tif (nextState === previousState) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tpreviousState = nextState\n\t\t\tlistener()\n\t\t}\n\n\t\treturn this.store.subscribe(handleChange)\n\t}\n\n\tpublic canDragSource(sourceId: string | undefined): boolean {\n\t\tif (!sourceId) {\n\t\t\treturn false\n\t\t}\n\t\tconst source = this.registry.getSource(sourceId)\n\t\tinvariant(source, `Expected to find a valid source. sourceId=${sourceId}`)\n\n\t\tif (this.isDragging()) {\n\t\t\treturn false\n\t\t}\n\n\t\treturn source.canDrag(this, sourceId)\n\t}\n\n\tpublic canDropOnTarget(targetId: string | undefined): boolean {\n\t\t// undefined on initial render\n\t\tif (!targetId) {\n\t\t\treturn false\n\t\t}\n\t\tconst target = this.registry.getTarget(targetId)\n\t\tinvariant(target, `Expected to find a valid target. targetId=${targetId}`)\n\n\t\tif (!this.isDragging() || this.didDrop()) {\n\t\t\treturn false\n\t\t}\n\n\t\tconst targetType = this.registry.getTargetType(targetId)\n\t\tconst draggedItemType = this.getItemType()\n\t\treturn (\n\t\t\tmatchesType(targetType, draggedItemType) && target.canDrop(this, targetId)\n\t\t)\n\t}\n\n\tpublic isDragging(): boolean {\n\t\treturn Boolean(this.getItemType())\n\t}\n\n\tpublic isDraggingSource(sourceId: string | undefined): boolean {\n\t\t// undefined on initial render\n\t\tif (!sourceId) {\n\t\t\treturn false\n\t\t}\n\t\tconst source = this.registry.getSource(sourceId, true)\n\t\tinvariant(source, `Expected to find a valid source. sourceId=${sourceId}`)\n\n\t\tif (!this.isDragging() || !this.isSourcePublic()) {\n\t\t\treturn false\n\t\t}\n\n\t\tconst sourceType = this.registry.getSourceType(sourceId)\n\t\tconst draggedItemType = this.getItemType()\n\t\tif (sourceType !== draggedItemType) {\n\t\t\treturn false\n\t\t}\n\n\t\treturn source.isDragging(this, sourceId)\n\t}\n\n\tpublic isOverTarget(\n\t\ttargetId: string | undefined,\n\t\toptions = { shallow: false },\n\t): boolean {\n\t\t// undefined on initial render\n\t\tif (!targetId) {\n\t\t\treturn false\n\t\t}\n\n\t\tconst { shallow } = options\n\t\tif (!this.isDragging()) {\n\t\t\treturn false\n\t\t}\n\n\t\tconst targetType = this.registry.getTargetType(targetId)\n\t\tconst draggedItemType = this.getItemType()\n\t\tif (draggedItemType && !matchesType(targetType, draggedItemType)) {\n\t\t\treturn false\n\t\t}\n\n\t\tconst targetIds = this.getTargetIds()\n\t\tif (!targetIds.length) {\n\t\t\treturn false\n\t\t}\n\n\t\tconst index = targetIds.indexOf(targetId)\n\t\tif (shallow) {\n\t\t\treturn index === targetIds.length - 1\n\t\t} else {\n\t\t\treturn index > -1\n\t\t}\n\t}\n\n\tpublic getItemType(): Identifier {\n\t\treturn this.store.getState().dragOperation.itemType as Identifier\n\t}\n\n\tpublic getItem(): any {\n\t\treturn this.store.getState().dragOperation.item\n\t}\n\n\tpublic getSourceId(): string | null {\n\t\treturn this.store.getState().dragOperation.sourceId\n\t}\n\n\tpublic getTargetIds(): string[] {\n\t\treturn this.store.getState().dragOperation.targetIds\n\t}\n\n\tpublic getDropResult(): any {\n\t\treturn this.store.getState().dragOperation.dropResult\n\t}\n\n\tpublic didDrop(): boolean {\n\t\treturn this.store.getState().dragOperation.didDrop\n\t}\n\n\tpublic isSourcePublic(): boolean {\n\t\treturn Boolean(this.store.getState().dragOperation.isSourcePublic)\n\t}\n\n\tpublic getInitialClientOffset(): XYCoord | null {\n\t\treturn this.store.getState().dragOffset.initialClientOffset\n\t}\n\n\tpublic getInitialSourceClientOffset(): XYCoord | null {\n\t\treturn this.store.getState().dragOffset.initialSourceClientOffset\n\t}\n\n\tpublic getClientOffset(): XYCoord | null {\n\t\treturn this.store.getState().dragOffset.clientOffset\n\t}\n\n\tpublic getSourceClientOffset(): XYCoord | null {\n\t\treturn getSourceClientOffset(this.store.getState().dragOffset)\n\t}\n\n\tpublic getDifferenceFromInitialOffset(): XYCoord | null {\n\t\treturn getDifferenceFromInitialOffset(this.store.getState().dragOffset)\n\t}\n}\n"],"names":["invariant","matchesType","getSourceClientOffset","getDifferenceFromInitialOffset","areDirty","DragDropMonitorImpl","subscribeToStateChange","listener","options","handlerIds","Array","isArray","prevStateId","store","getState","stateId","handleChange","state","currentStateId","canSkipListener","dirtyHandlerIds","subscribe","subscribeToOffsetChange","previousState","dragOffset","nextState","canDragSource","sourceId","source","registry","getSource","isDragging","canDrag","canDropOnTarget","targetId","target","getTarget","didDrop","targetType","getTargetType","draggedItemType","getItemType","canDrop","Boolean","isDraggingSource","isSourcePublic","sourceType","getSourceType","isOverTarget","shallow","targetIds","getTargetIds","length","index","indexOf","dragOperation","itemType","getItem","item","getSourceId","getDropResult","dropResult","getInitialClientOffset","initialClientOffset","getInitialSourceClientOffset","initialSourceClientOffset","getClientOffset","clientOffset"],"mappings":"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"}