{"version":3,"sources":["../../../src/classes/HandlerRegistryImpl.ts"],"sourcesContent":["import type { Store } from 'redux'\nimport { invariant } from '@react-dnd/invariant'\nimport {\n\taddSource,\n\taddTarget,\n\tremoveSource,\n\tremoveTarget,\n} from '../actions/registry.js'\nimport { getNextUniqueId } from '../utils/getNextUniqueId.js'\nimport type { State } from '../reducers/index.js'\nimport {\n\tDragSource,\n\tDropTarget,\n\tSourceType,\n\tTargetType,\n\tIdentifier,\n\tHandlerRole,\n\tHandlerRegistry,\n} from '../interfaces.js'\nimport {\n\tvalidateSourceContract,\n\tvalidateTargetContract,\n\tvalidateType,\n} from '../contracts.js'\nimport { asap } from '@react-dnd/asap'\n\nfunction getNextHandlerId(role: HandlerRole): string {\n\tconst id = getNextUniqueId().toString()\n\tswitch (role) {\n\t\tcase HandlerRole.SOURCE:\n\t\t\treturn `S${id}`\n\t\tcase HandlerRole.TARGET:\n\t\t\treturn `T${id}`\n\t\tdefault:\n\t\t\tthrow new Error(`Unknown Handler Role: ${role}`)\n\t}\n}\n\nfunction parseRoleFromHandlerId(handlerId: string) {\n\tswitch (handlerId[0]) {\n\t\tcase 'S':\n\t\t\treturn HandlerRole.SOURCE\n\t\tcase 'T':\n\t\t\treturn HandlerRole.TARGET\n\t\tdefault:\n\t\t\tthrow new Error(`Cannot parse handler ID: ${handlerId}`)\n\t}\n}\n\nfunction mapContainsValue<T>(map: Map<string, T>, searchValue: T) {\n\tconst entries = map.entries()\n\tlet isDone = false\n\tdo {\n\t\tconst {\n\t\t\tdone,\n\t\t\tvalue: [, value],\n\t\t} = entries.next()\n\t\tif (value === searchValue) {\n\t\t\treturn true\n\t\t}\n\t\tisDone = !!done\n\t} while (!isDone)\n\treturn false\n}\n\nexport class HandlerRegistryImpl implements HandlerRegistry {\n\tprivate types: Map<string, SourceType | TargetType> = new Map()\n\tprivate dragSources: Map<string, DragSource> = new Map()\n\tprivate dropTargets: Map<string, DropTarget> = new Map()\n\tprivate pinnedSourceId: string | null = null\n\tprivate pinnedSource: any = null\n\tprivate store: Store<State>\n\n\tpublic constructor(store: Store<State>) {\n\t\tthis.store = store\n\t}\n\n\tpublic addSource(type: SourceType, source: DragSource): string {\n\t\tvalidateType(type)\n\t\tvalidateSourceContract(source)\n\n\t\tconst sourceId = this.addHandler(HandlerRole.SOURCE, type, source)\n\t\tthis.store.dispatch(addSource(sourceId))\n\t\treturn sourceId\n\t}\n\n\tpublic addTarget(type: TargetType, target: DropTarget): string {\n\t\tvalidateType(type, true)\n\t\tvalidateTargetContract(target)\n\n\t\tconst targetId = this.addHandler(HandlerRole.TARGET, type, target)\n\t\tthis.store.dispatch(addTarget(targetId))\n\t\treturn targetId\n\t}\n\n\tpublic containsHandler(handler: DragSource | DropTarget): boolean {\n\t\treturn (\n\t\t\tmapContainsValue(this.dragSources, handler) ||\n\t\t\tmapContainsValue(this.dropTargets, handler)\n\t\t)\n\t}\n\n\tpublic getSource(sourceId: string, includePinned = false): DragSource {\n\t\tinvariant(this.isSourceId(sourceId), 'Expected a valid source ID.')\n\t\tconst isPinned = includePinned && sourceId === this.pinnedSourceId\n\t\tconst source = isPinned ? this.pinnedSource : this.dragSources.get(sourceId)\n\t\treturn source\n\t}\n\n\tpublic getTarget(targetId: string): DropTarget {\n\t\tinvariant(this.isTargetId(targetId), 'Expected a valid target ID.')\n\t\treturn this.dropTargets.get(targetId) as DropTarget\n\t}\n\n\tpublic getSourceType(sourceId: string): Identifier {\n\t\tinvariant(this.isSourceId(sourceId), 'Expected a valid source ID.')\n\t\treturn this.types.get(sourceId) as Identifier\n\t}\n\n\tpublic getTargetType(targetId: string): Identifier | Identifier[] {\n\t\tinvariant(this.isTargetId(targetId), 'Expected a valid target ID.')\n\t\treturn this.types.get(targetId) as Identifier | Identifier[]\n\t}\n\n\tpublic isSourceId(handlerId: string): boolean {\n\t\tconst role = parseRoleFromHandlerId(handlerId)\n\t\treturn role === HandlerRole.SOURCE\n\t}\n\n\tpublic isTargetId(handlerId: string): boolean {\n\t\tconst role = parseRoleFromHandlerId(handlerId)\n\t\treturn role === HandlerRole.TARGET\n\t}\n\n\tpublic removeSource(sourceId: string): void {\n\t\tinvariant(this.getSource(sourceId), 'Expected an existing source.')\n\t\tthis.store.dispatch(removeSource(sourceId))\n\t\tasap(() => {\n\t\t\tthis.dragSources.delete(sourceId)\n\t\t\tthis.types.delete(sourceId)\n\t\t})\n\t}\n\n\tpublic removeTarget(targetId: string): void {\n\t\tinvariant(this.getTarget(targetId), 'Expected an existing target.')\n\t\tthis.store.dispatch(removeTarget(targetId))\n\t\tthis.dropTargets.delete(targetId)\n\t\tthis.types.delete(targetId)\n\t}\n\n\tpublic pinSource(sourceId: string): void {\n\t\tconst source = this.getSource(sourceId)\n\t\tinvariant(source, 'Expected an existing source.')\n\n\t\tthis.pinnedSourceId = sourceId\n\t\tthis.pinnedSource = source\n\t}\n\n\tpublic unpinSource(): void {\n\t\tinvariant(this.pinnedSource, 'No source is pinned at the time.')\n\n\t\tthis.pinnedSourceId = null\n\t\tthis.pinnedSource = null\n\t}\n\n\tprivate addHandler(\n\t\trole: HandlerRole,\n\t\ttype: SourceType | TargetType,\n\t\thandler: DragSource | DropTarget,\n\t): string {\n\t\tconst id = getNextHandlerId(role)\n\t\tthis.types.set(id, type)\n\t\tif (role === HandlerRole.SOURCE) {\n\t\t\tthis.dragSources.set(id, handler as DragSource)\n\t\t} else if (role === HandlerRole.TARGET) {\n\t\t\tthis.dropTargets.set(id, handler as DropTarget)\n\t\t}\n\t\treturn id\n\t}\n}\n"],"names":["invariant","addSource","addTarget","removeSource","removeTarget","getNextUniqueId","HandlerRole","validateSourceContract","validateTargetContract","validateType","asap","getNextHandlerId","role","id","toString","SOURCE","TARGET","Error","parseRoleFromHandlerId","handlerId","mapContainsValue","map","searchValue","entries","isDone","done","value","next","HandlerRegistryImpl","type","source","sourceId","addHandler","store","dispatch","target","targetId","containsHandler","handler","dragSources","dropTargets","getSource","includePinned","isSourceId","isPinned","pinnedSourceId","pinnedSource","get","getTarget","isTargetId","getSourceType","types","getTargetType","delete","pinSource","unpinSource","set","Map"],"mappings":"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"}